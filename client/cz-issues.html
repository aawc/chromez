<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<script src="../bower_components/papaparse/papaparse.min.js"></script>

<dom-module id="cz-issues">

  <template>
    <template is="dom-repeat" items="{{searchQueries}}">
      <iron-ajax
        auto
        params="{{item.params}}"
        handle-as="text"
        url="../?"
        on-response="handleResponse"
        content-type='text/plain'
        verbose=true></iron-ajax>
    </template>
  </template>

  <script>
    Polymer({
      is: "cz-issues",

      properties: {
        searchQueries: {
          type: Object,
          value: function() { return []; }
        }
      },

      handleResponse: function(data) {
        var query = this.searchQueries[data.model.index];
        var result = data.detail.response;
        result = Papa.parse(result, {header: true}).data;
        result = result.filter(a => a.ID !== "");
        query.dataCache = data.detail.response;
        query.element = data.target;
        for (var i = 0; i < query.callbacks.length; i++)
          query.callbacks[i](result);
      },

      registerQuery: function(query, callback) {
        if (query.type == 'open') {
          for (var i = 0; i < this.searchQueries.length; i++) {
            if (this.searchQueries[i].user == query.user) {
              this.searchQueries[i].callbacks.push(callback);
              if (this.searchQueries[i].dataCache)
                callback(this.searchQueries[i].dataCache);
              return;
            }
          }
          this.push('searchQueries', {
            callbacks: [callback],
            user: query.user,
            params: {
              site: 'issues',
              can: 2,
              q: "owner:" + query.user,
              colspec: "ID+Pri+M+Stars+ReleaseBlock+Cr+Status+Owner+Summary+OS+Modified",
              x: "m",
              y: "releaseblock",
              cells: "tiles"
            }
          });
        }
      }
    });
  </script>
</dom-module>
