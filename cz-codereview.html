<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/iron-ajax/iron-ajax.html">

<dom-module id="cz-codereview">

  <template>
    <template is="dom-repeat" items="{{searchQueries}}">
      <iron-ajax
        auto
        params="{{item.params}}"
        handleAs="json"
        url="https://codereview.chromium.org/search"
        on-response="handleResponse"></iron-ajax>
    </template>
  </template>

  <script>
    Polymer({
      is: "cz-codereview",

      update: function() {
        for (var i = 0; i < this.searchQueries.length; i++) {
          this.searchQueries[i].element.generateRequest();
        }
      },

      properties: {
        searchQueries: {
          type: Object,
          value: function() { return []; }
        }
      },

      handleResponse: function(data) {
        var query = this.searchQueries[data.model.index];
        query.dataCache = data.detail.response;
        query.element = data.target;
        for (var i = 0; i < query.callbacks.length; i++)
          query.callbacks[i](data.detail.response);
      },

      registerQuery: function(query, callback) {
        if (query.type == 'search') {
          for (var i = 0; i < this.searchQueries.length; i++) {
            if (this.searchQueries[i].user == query.user) {
              this.searchQueries[i].callbacks.push(callback);
              if (this.searchQueries[i].dataCache)
                callback(this.searchQueries[i].dataCache);
              return;
            }
          }
          this.push('searchQueries', {
            callbacks: [callback],
            user: query.user,
            params: {
              reviewer: query.user,
              closed: 3,
              format: 'json',
              with_messages: 'True',
              limit: 100
            }
          });
        }
      }
    });
  </script>

</dom-module>
