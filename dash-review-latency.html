
<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/iron-ajax/iron-ajax.html">

<dom-module id="dash-review-latency">

  <template>
    <iron-ajax
      id='search'
      auto
      params="{{params}}"
      handleAs="json"
      url="https://codereview.chromium.org/search"
      on-response="handleResponse"></iron-ajax>
  </template>

  <script>
    Polymer({
      is: "dash-review-latency",
      properties: {
        params: {
          type: Object,
          value: function() { return {
            reviewer: 'shans',
            closed: 3,
            format: 'json',
            with_messages: 'True',
            limit: 100
          }}
        }
      },

      handleResponse(response) {
        var data = response.detail.response;
        console.log(data.results[0]);

        for (var i = 0; i < data.results.length; i++) {
          var issue = data.results[i];
          var reviewers = issue.reviewers;
          console.log(issue.issue, reviewers);
          var foundAuthorComment = false;
          var lastAuthorTimestamp = undefined;
          for (var j = issue.messages.length - 1; j >= 0; j--) {
            var message = issue.messages[j];
            if (message.auto_generated)
              continue;
            if (message.sender == issue.owner_email) {
              foundAuthorComment = true;
              lastAuthorTimestamp = message.date;
              continue;
            }
            if (!foundAuthorComment) {
              var idx = reviewers.indexOf(message.sender);
              if (idx > -1)
                reviewers.splice(idx, 1);
            }
            console.log('\t', message.sender, message.date, reviewers);
          }

          if (lastAuthorTimestamp == undefined)
            lastAuthorTimestamp = issue.created;
     
          if (reviewers.length == 1)
            console.log(reviewers[0], lastAuthorTimestamp);
 
        }
      }
    });
  </script>
</dom-module>

<dash-review-latency></dash-review-latency>
